# See: https://taskfile.dev/api/

version: "3"

tasks:
  generate:
    aliases:
      - gen
    desc: "Generate code from proto files"
    cmds:
      - protoc -I proto proto/librarian/*.proto --go_out=./gen/go/ --go_opt=paths=source_relative --go-grpc_out=./gen/go/ --go-grpc_opt=paths=source_relative


  tag-next:
    desc: –°–æ–∑–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–≥ (patch –≤–µ—Ä—Å–∏—è)
    interactive: true
    cmds:
      - |
        set -e
        echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞..."
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º v0.0.0 –µ—Å–ª–∏ —Ç–µ–≥–æ–≤ –Ω–µ—Ç
        if LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null); then
          echo "‚úÖ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥: $LAST_TAG"
        else
          LAST_TAG="v0.0.0"
          echo "‚ÑπÔ∏è –¢–µ–≥–æ–≤ –µ—â–µ –Ω–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º —Å $LAST_TAG"
        fi
        
        # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å 'v' –µ—Å–ª–∏ –µ—Å—Ç—å
        LAST_TAG=${LAST_TAG#v}
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –Ω–∞ —á–∞—Å—Ç–∏
        IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST_TAG" || true
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        MAJOR=${MAJOR:-0}
        MINOR=${MINOR:-0}
        PATCH=${PATCH:-0}
        
        # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º patch –≤–µ—Ä—Å–∏—é
        PATCH=$((PATCH + 1))
        NEXT_TAG="v${MAJOR}.${MINOR}.${PATCH}"
        
        echo ""
        echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–≥–µ:"
        echo "   –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥: v${MAJOR}.${MINOR}.$((PATCH - 1))"
        echo "   –°–ª–µ–¥—É—é—â–∏–π —Ç–µ–≥: $NEXT_TAG"
        echo "   –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $(git rev-parse --short HEAD)"
        echo ""
        
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        read -p "üöÄ –°–æ–∑–¥–∞—Ç—å —Ç–µ–≥ $NEXT_TAG? (y/N): " CONFIRM
        
        if [[ "$CONFIRM" == "y" || "$CONFIRM" == "Y" ]]; then
          git tag -a "$NEXT_TAG" -m "Release $NEXT_TAG"
          echo "‚úÖ –¢–µ–≥ $NEXT_TAG —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
          echo ""
          echo "–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–≥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
          echo "  git push origin $NEXT_TAG"
          echo "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: task tag-push"
        else
          echo "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ"
        fi